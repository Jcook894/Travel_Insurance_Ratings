<?php
/**
 * RapidLauncher Addon for JReviews
 * Copyright (C) 2010-2016 ClickFWD LLC
 * This is not free software, do not distribute it.
 * For licencing information visit https://www.jreviews.com
 * or contact sales@jreviews.com
**/

defined( 'MVC_FRAMEWORK') or die;

S2App::Import('Model', array('rapidlauncher_field_group', 'rapidlauncher_listing_type'), 'jreviews');

class RapidlauncherListingTypeHelperComponent
{
	protected $fieldGroup;

	protected $listingType;

	public function startup(& $controller)
	{
		$this->fieldGroup = ClassRegistry::getClass('RapidlauncherFieldGroupModel');

		$this->listingType = ClassRegistry::getClass('RapidlauncherListingTypeModel');
	}

	public function import($rows)
	{
		// Remove header row

		array_shift($rows);

		foreach($rows AS $row)
		{
			$row = array_pad($row, 5, '');

			$this->create(array('title', 'groups', 'config', 'state', 'search'), $row);
		}
	}

	public function create($columns, $row)
	{
		$data = array_combine($columns, $row);

		$config = $data['config'] ?: '{"social_sharing_detail":["-1"],"twitter_hashtag":"-1","geomaps.enable_map_detail":"1","geomaps.enable_map_list":"1","geomaps.detail_header_cover":"-1","list_show_page_catimage":"-1","list_show_catimages":"-1","list_show_searchbox":"-1","list_compare":"-1","list_show_orderselect":"-1","list_order_default":"-1","list_order_options":["-1"],"list_order_criteria":"-1","list_order_field":"","media_photo_function_cover":"-1","media_photo_function_logo":"-1","listing_detail_header_empty_cover":"-1","listing_detail_header_empty_cover_color":"-1","listing_detail_header_empty_logo":"-1","listing_detail_header_empty_logo_color":"-1","listing_detail_header_avatar":"-1","favorites_enable":"-1","claims_enable":"-1","inquiry_enable":"-1","summary_desc_char_limit":"-1","list_show_date":"-1","list_show_author":"-1","list_show_user_rating":"-1","list_show_editor_rating":"-1","list_show_hits":"-1","list_show_abstract":"-1","list_abstract_trim":"-1","list_new":"-1","list_new_days":"-1","list_hot":"-1","list_hot_hits":"-1","list_featured":"-1","listing_publication_date":"0","listing_expiration_date":"0","content_summary":"-1","content_description":"-1","content_show_reviewform":"-1","reviewform_optional":"-1","rating_increment":"-1","rating_histogram":"-1","author_review":"-1","authorids":"-1","user_review_order":"-1","review_order_options":["-1"],"user_owner_disable":"-1","editor_review_char_limit":"-1","user_review_char_limit":"-1","review_discussions":"-1","reviewform_title":"-1","reviewform_comment":"-1","lang_listing_edit":"LANG_LISTING_EDIT","lang_listing_create":"LANG_LISTING_CREATE","lang_listing_form_title":"LANG_LISTING_FORM_TITLE","lang_listing_form_title_alias":"LANG_LISTING_FORM_TITLE_ALIAS","lang_listing_form_summary":"LANG_LISTING_FORM_SUMMARY","lang_listing_form_description":"LANG_LISTING_FORM_DESCRIPTION","lang_listing_form_upload_media_info":"LANG_LISTING_FORM_UPLOAD_MEDIA_INFO","lang_listing_media_upload_header":"LANG_LISTING_MEDIA_UPLOAD_HEADER","lang_review_media_upload_header":"LANG_REVIEW_MEDIA_UPLOAD_HEADER","lang_media_photo_function_gallery":"LANG_MEDIA_PHOTO_FUNCTION_GALLERY","lang_media_photo_function_logo":"LANG_MEDIA_PHOTO_FUNCTION_LOGO","lang_media_photo_function_cover":"LANG_MEDIA_PHOTO_FUNCTION_COVER","addnewaccess":["-1"],"moderation_item":["-1"],"moderation_item_edit":"-1","editaccess":["-1"],"listing_publish_access":["-1"],"listing_delete_access":["-1"],"addnewwysiwyg":["-1"],"addnewmeta":["-1"],"addnewaccess_reviews":["-1"],"moderation_reviews":["-1"],"moderation_editor_reviews":"-1","moderation_review_edit":"-1","moderation_editor_review_edit":"-1","user_vote_public":["-1"],"editaccess_reviews":["-1"],"addnewaccess_posts":["-1"],"post_edit_access":["-1"],"post_delete_access":["-1"],"media_general_default_image_path":"-1","media_general_default_order_listing":"-1","media_report_abuse":"-1","media_photo_show_count":"-1","media_video_show_count":"-1","media_attachment_show_count":"-1","media_audio_show_count":"-1","media_list_thumbnail":"-1","media_list_thumbnail_mode":"-1","media_list_thumbnail_size":"-1","media_list_category_image":"-1","media_list_default_image":"-1","media_detail_separate_media":"-1","media_detail_photo_layout":"-1","media_detail_video_layout":"-1","media_detail_audio_downloads":"-1","media_detail_main":"-1","media_detail_main_lightbox_disable":"-1","media_detail_main_thumbnail_mode":"-1","media_detail_main_thumbnail_size":"-1","media_detail_default":"-1","media_detail_main_thumbnail_alignment":"-1","media_detail_gallery_thumbnail_mode":"-1","media_detail_gallery_thumbnail_size":"-1","media_photo_gallery_overlay":"-1","media_detail_photo_limit":"-1","media_detail_video_limit":"-1","media_access_view_photo_listing":"-1","media_access_view_video_listing":"-1","media_access_view_attachment_listing":"-1","media_access_view_audio_listing":"-1","media_access_view_photo_review":"-1","media_access_view_video_review":"-1","media_access_view_attachment_review":"-1","media_access_view_audio_review":"-1","media_access_upload_url_listing":["-1"],"media_access_submit_photo_listing":["-1"],"media_access_submit_photo_listing_owner":"-1","media_access_submit_video_listing":["-1"],"media_access_submit_video_listing_owner":"-1","media_access_submit_attachment_listing":["-1"],"media_access_submit_attachment_listing_owner":"-1","media_access_submit_audio_listing":["-1"],"media_access_submit_audio_listing_owner":"-1","media_access_upload_url_review":["-1"],"media_access_submit_photo_review":["-1"],"media_access_submit_video_review":["-1"],"media_access_submit_attachment_review":["-1"],"media_access_submit_audio_review":["-1"],"media_access_moderate_photo":["-1"],"media_access_moderate_video":["-1"],"media_access_moderate_attachment":["-1"],"media_access_moderate_audio":["-1"],"media_access_moderate_edit":"-1","media_photo_max_uploads_listing":"-1","media_photo_max_uploads_review":"-1","media_photo_max_size":"-1","media_photo_extensions":"-1","media_photo_resize":"-1","media_photo_resize_quality":"-1","media_video_upload_methods":"-1","media_video_link_sites":["-1"],"media_video_max_uploads_listing":"-1","media_video_max_uploads_review":"-1","media_video_max_size":"-1","media_video_extensions":"-1","media_attachment_max_uploads_listing":"-1","media_attachment_max_uploads_review":"-1","media_attachment_max_size":"-1","media_attachment_extensions":"-1","media_audio_max_uploads_listing":"-1","media_audio_max_uploads_review":"-1","media_audio_max_size":"-1","media_audio_extensions":"-1","schema_org_type":"Article","facebook_opengraph_type":"article","twitter_card":"summary","twitter_card_username":"","type_metatitle":"","override_listing_title":"0","type_metakey":"","type_metadesc":"","review_pagetitle":"","review_metakey":"","review_metadesc":"","relatedlistings":[{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","curr_fname":"","match":"id","match_fname":"","listing_order":"rdate","radius":"","distance":"1","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","summary":"0","summary_words":"10","show_category":"1","fields":"","editor_rating":"1","user_rating":"1","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","compare":"0","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"}],"relatedreviews":[{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","reviews_order":"latest","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","link_title":"{listing_title}","review_link":"0","show_comments":"0","comments_words":"10","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","reviews_order":"latest","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","link_title":"{listing_title}","review_link":"0","show_comments":"0","comments_words":"10","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","reviews_order":"latest","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","link_title":"{listing_title}","review_link":"0","show_comments":"0","comments_words":"10","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","reviews_order":"latest","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","link_title":"{listing_title}","review_link":"0","show_comments":"0","comments_words":"10","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"},{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","reviews_order":"latest","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","custom_where":"","custom_order":"","link_title":"{listing_title}","review_link":"0","show_comments":"0","comments_words":"10","tn_show":"1","tn_position":"left","tn_mode":"crop","tn_size":"100x100","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"}],"userfavorites":{"enable":"0","title":"","target_id":"jrRelatedListings","target_class":"","avatar":"0","tmpl_suffix":"","module_total":"12","module_limit":"6","columns":"3","tn_show":"1","tn_mode":"crop","tn_size":"100x100","nav_position":"side","orientation":"horizontal","slideshow":"0","slideshow_interval":"6"}}';

		$listingTypeData = [
			'title' => $data['title'],
			'groupid' => '',
			'state' => $data['state'],
			'search' => $data['search'],
			'config' => $config
		];

		// First get the group ids from the group titles

		$groupTitles = Sanitize::getString($data, 'groups');

		$groupTitles = explode(',', $groupTitles);

		if($groupIds = $this->fieldGroup->getGroupId($groupTitles))
		{
			$listingTypeData['groupid'] = implode(',', $groupIds);
		}

		// Create the new listing type

		$this->listingType->create($listingTypeData);
	}

	public function export($dirId)
	{
		$listingTypeIds = $this->listingType->getListingTypeFromDirectory($dirId);

		return $this->listingType->read($listingTypeIds);
	}
}