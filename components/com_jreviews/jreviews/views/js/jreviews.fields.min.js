!function(e){function t(t){var a,i,n,l=!1,o=this,r=t,s=r.find(':input[class^="jr_"]'),d=r.find('fieldset[id^="group_"]'),c=r.find('li[id^="tab_"]'),p={},u=!1;this.getTabs=function(){return c},this.click2add=function(){r.off("click",".jr-click2add-new").on("click",".jr-click2add-new",function(t){t.preventDefault(),e(this).closest("div.jrFieldDiv").find('div.jr-click2add-option:not(".jr-ready")').addClass("jr-ready").toggle(50,function(){e(this).removeClass("jr-ready")})}),r.off("click",".jr-click2add-submit").on("click",".jr-click2add-submit",function(t){t.preventDefault();var a,i,n=e(this),l=n.parent().siblings("select"),o=n.prev(":input"),r=o.val(),s="";!l.data("controlledBy")||l.data("fieldName")in l.data("controlledBy")||e.each(l.data("controlledBy"),function(e,t){a=e,i=t,s="|"+e+"|"+t});var d=encodeURIComponent(r).replace(/'/g,"&#039;")+"|click2add"+s,c=l.children('option[value="'+d+'"]');""!==r&&0===c.length?(l.append(e("<option></option>").attr({value:d,selected:"selected","data-ordering":99999,"data-controlledBy":a,"data-controlValue":i}).text(r)).data("isActive",!0).trigger("change"),o.val("")):1==c.length&&c.prop("selected",!0),n.siblings(".jr_validation").remove()})},this.loadData=function(t){var l={fieldLocation:"Listing",entry_id:null,context:null,value:[],page_setup:0,recallValues:!0,autocomplete:!0,lang:{select_field:jreviews.__t("FIELD_SELECT_FIELD"),no_results:jreviews.__t("FIELD_NO_RESULTS"),instructions:jreviews.__t("FIELD_AUTOCOMPLETE_HELP")}},c={},p=[];if(t=e.extend(l,t),n=t.entry_id,t.page_setup=t.page_setup?1:0,a=t,a.res=a.res||{},void 0!==jreviews.paid&&"Listing"==a.fieldLocation)try{void 0!==a.res.planList?(u=!0,jreviews.paid.plan.planList=a.res.planList,jreviews.paid.plan.plan_selected=a.res.plan_selected||jreviews.paid.plan.plan_selected,jreviews.paid.plan.plan_selected&&r.find('#jr-paid-plan-list :radio[value="'+jreviews.paid.plan.plan_selected+'"]').prop("checked",!0)):"object"==typeof jreviews.paid.plan.planList&&null!==jreviews.paid.plan.plan_selected&&(u=!0)}catch(h){}if(i=d.map(function(){return this.id.replace(/group_/g,"")}),s.each(function(){if("button"!=e(this).prop("type")){var t=e(this).data("selected"),a=e(this).attr("class").split(" ")[0].replace(/[^a-zA-Z0-9_\s]+/g,"").match(/^jr_[a-z0-9]+/).toString();t&&(c[a]=String(t).search("_")>-1?t.split("_"):[t],e(this).removeAttr("data-selected"),e(this).removeData("selected")),-1==e.inArray(a,p)&&p.push(a)}}),p=e.unique(p),p.length){e.isEmptyObject(p)||(t.value=c);var f=jreviews.dispatch({method:"POST",type:"json",data:{"data[controller]":"fields","data[action]":"_loadFieldData","data[entry_id]":t.entry_id,"data[context]":t.context,"data[fields]":p,"data[value]":c,"data[page_setup]":t.page_setup,"data[fieldLocation]":t.fieldLocation,"data[referrer]":t.referrer,"data[autocomplete]":t.autocomplete}});return f.done(function(i){o.processResponse(t.value,t.page_setup,i),u&&(jreviews.paid.plan.controlFieldClass=o,jreviews.paid.plan.formFilter(r)),o.click2add(),"Listing"==a.fieldLocation&&(r.trigger("jrListingFieldsLoaded"),"function"==typeof e().jrFilterTransformer&&e.inArray(a.referrer,["filtering"])>-1&&r.find('[data-display-as][name^="data[Field]"]').jrFilterTransformer().data("plugin_jrFilterTransformer")),"Review"==a.fieldLocation&&r.trigger("jrReviewFieldsLoaded"),r.jrApplyFieldOptionLayout()}),f}return!1},this.getPaidFields=function(){var e=jreviews.paid.plan.planList,t=(r.find("#jr-paid-plan-list"),jreviews.paid.plan.plan_selected);return"object"==typeof e&&null!==t?void 0!==e["plan"+t]?e["plan"+t].fields:[]:void 0},this.getFieldOptions=function(e,t){var a;switch(t){case"select":case"selectmultiple":a=e.children("option");break;default:a=e}return a},this.getFieldObj=function(e){return e in p?p[e]:!1},this.setValidFields=function(t){var a=[];t=t||r,r.find(":input").filter(function(){e(this).closest("fieldset").data("isActive")!==!1&&e(this).data("isActive")===!0&&a.push(e(this).data("fieldName"))});var i=t.find('[name="data[valid_fields]"]');return i.length?i.val(a.join(",")):t.append(e('<input type="hidden" name="data[valid_fields]" />').val(a.join(","))),e.unique(a)},this.getjQueryObj=function(t,i){if(void 0===t.fields||!(i in t.fields))return!1;var n=!1;if(i in p)return p[i];var l=["selectmultiple","checkboxes","relatedlisting"];if(e.inArray(a.referrer,["adv_search_module","filtering"])>-1){var o,s=r.find("."+i);switch(o=s.prop("type")){case"select-one":t.fields[i].type="select";break;case"select-multiple":t.fields[i].type="selectmultiple"}}e.inArray(a.referrer,["adv_search_module","adv_search","filtering"])>-1&&e.inArray(t.fields[i].type,["integer","decimal","date"])>-1&&(n=!0);var d=e.inArray(t.fields[i].type,l)>-1||n,c=':input[name="data[Field]['+t.location+"]["+i+"]"+(d?'[]"]':'"]');return p[i]=r.find(c),p[i]},this.storeValues=function(t,a){{var i=t.data("fieldOptions")||{},n=t.data("fieldType");o.getFieldOptions(t,n)}a=e.isArray(a)?a:[a],e(a).each(function(n,l){l in i&&(e(i[l].dependent_groups).each(function(n,r){e.each(i[l].fields,function(e,n){if(n.group==r&&void 0!==i[a]){var s=o.getjQueryObj(i[a],n.name),d=o.getFieldValue(s);if(s.data("isControlled")===!1||s.data("isControlled")===!0&&s.data("hasControl")===!0){o.debug("6.1 >--- Store current val of "+s.data("fieldName")+"["+d+"] for "+t.data("fieldName")+"["+l+"]");var c=s.data("parentMemory")||[],p=t.data("fieldName")+"."+l;c[p]=d,s.data("parentMemory",c)}s.data("hasControl")===!0&&(o.debug("6.1 >--- Run recursively for ["+s.attr("class").split(" ")[0]+"["+d+"]"),null!==d&&o.storeValues(s,d))}})}),e(i[l].dependent_fields).each(function(e,a){var n=o.getjQueryObj(i[l],a);if(0===n.length)return!0;var r=i[l].fields[a].type;o.debug("6.2 >--- Store current val of "+r+" "+n.data("fieldName")+"["+n.val()+"] for "+t.data("fieldName")+"["+l+"]");var s=n.data("parentMemory")||[],d=t.data("fieldName")+"."+l,c=o.getFieldValue(n);s[d]=c,n.data("parentMemory",s),null!==c&&(o.debug("6.2 >--- Run recursively"),o.storeValues(n,c))}))})},this.getFieldValue=function(e){var t;switch(e.data("fieldType")){case"checkboxes":case"radiobuttons":t=e.filter(":checked").map(function(){return this.value}).get();break;default:t=e.val()}return t},this.clearFieldValue=function(e){switch(e.data("fieldType")){case"checkboxes":case"radiobuttons":e.prop("checked",!1);break;default:e.val("")}return e},this.recallValue=function(t,a,i){var n=t.data("parentMemory")||[],l=a+"."+i;if(void 0!==n[l]){o.debug("** Recall ParentMemory:"+t.data("fieldName")+" = ["+a+":"+i+"] => "+n[l]);var r=t.data("fieldType");e.inArray(r,["checkboxes","radiobuttons"])>-1?t.each(function(){var t=e(this).val();e(this).prop("checked",e.inArray(t,n[l])>-1)}):t.val(n[l]),t.trigger("change")}},this.clearDependents=function(e,t,a){setTimeout(function(){o.clearDependentsDelayed(e,t,a)},100)},this.clearDependentsDelayed=function(t,a,i){var n=t.data("fieldOptions")||{},l=[],r=t.data("fieldType"),s=o.getFieldOptions(t,r);o.debug("5 >--- Clear dependents of "+t.attr("class").split(" ")[0]+"["+a+"]. Event type is "+t.data("eventType")),l=e.isArray(a)?a:[a],e(l).each(function(t,a){a in n&&(e(n[a].dependent_groups).each(function(t,i){o.debug("Hide dependent group: "+i);var l=!0;if(s.each(function(){var t=e(this);n[t.val()]&&(t.is(":checked")||t.is(":selected"))&&e.inArray(i,n[t.val()].dependent_groups)>-1&&(l=!1)}),l){var r=d.filter("fieldset#group_"+i);r.data("isActive",!1).css("display","none"),e.each(n[a].fields,function(e,t){if(t.group==i&&void 0!==n[a]){var l=o.getjQueryObj(n[a],t.name);o.clearFieldValue(l).data("doNotStore",!0).trigger("change")}}),c.length&&c.filter("li#tab_"+i).hide()}}),e(n[a].dependent_fields).each(function(t,l){var d=o.getjQueryObj(n[a],l);if(0===d.length)return!0;var c=n[a].fields[l].type;o.debug("5.0 >--- Clear dependent ["+l+"]["+a+"]["+c+"]");d.val();if(e.inArray(c,["select","selectmultiple"])>-1){o.debug("5.1 >---",c),e(n[a].fields[l].options).each(function(){var t=this.value;if(o.debug(l+"["+c+"]["+t+"]"),e.inArray(r,["checkboxes","selectmultiple"]>-1)){var a=!0;s.each(function(){var i=e(this);n[i.val()]&&(i.is(":checked")||i.is(":selected"))&&e(n[i.val()].fields[l]).each(function(){e(this.options).each(function(){this.value==t&&(a=!1)})})}),a&&(o.debug("5.1.1 >----- Removing field option ["+t+"]"),d.children('option[value="'+t+'"]').remove())}else o.debug("5.1.2 >-----"),d.children('option[value="'+t+'"]').remove();null!==t&&o.clearDependents(d,t)}),d.data("old_val","");var p=d.children("option").length;if("select"==c&&1==p||"selectmultiple"==c&&0===p){var u=d.data("click2add")||0;(0===u||1==u&&d.data("isControlled"))&&d.data("isActive",!1).val("").closest("div.jrFieldDiv").css("display","none")}}else{o.debug("5.2 >--- "+c),d.data("old_val","");var h=!0;e.inArray(r,["checkboxes","selectmultiple"]>-1)?(s.each(function(){var t=e(this);n[t.val()]&&(t.is(":checked")||t.is(":selected"))&&e.inArray(l,n[t.val()].dependent_fields)>-1&&(h=!1)}),h&&o.clearFieldValue(d)):o.clearFieldValue(d),!h||void 0!==i&&void 0!==n[i]&&n[i].dependent_fields.length>0&&e.inArray(l,n[i].dependent_fields)>-1||(o.debug("   ----- Hiding dependent field "+l),d.data("isActive",!1).closest("div.jrFieldDiv").css("display","none"))}d.trigger("change")}))})},this.processResponse=function(t,i,l){if(0!==l.length){if(void 0!==l.responses&&(e.each(l.responses,function(t,a){var i=o.getjQueryObj(l,t);return i?void e.each(a,function(e,a){o.debug("1 >-- Caching response data for "+t+"["+a.control_value+"]");var n=i.data("fieldOptions")||{};n[a.control_value]=a,i.data("fieldOptions",n)}):!0}),i)){o.populateOptions(l);try{var s=r.find(".jrRelatedListing");s.autocompletefield({lookup:"listings",entry_id:n,optionType:s.data("autocompleteType"),optionDivPosition:s.data("autocompletePos")})}catch(d){}}e.each(l.control_field,function(t,i){var n=o.getjQueryObj(l,i);return void 0===l.fields||"text"==l.fields[i].type?!0:n.data("hasControl")!==!1||n.hasClass("jrAutoComplete")?(n.on("change",function(){o.debug("2 >--- Change event triggered for "+i+", id = "+n.attr("class").split(" ")[0]+", "+l.fields[i].type);var t,r="",s=[],d=[],c=n.data("old_val")||(e.inArray(l.fields[i].type,["selectmultiple"])?[]:null);switch(o.debug("   Old val: "+c),l.fields[i].type){case"selectmultiple":if(n.children("option").not(":selected").each(function(){d.push(e(this).val())}),s=n.val(),null===s&&(s=[]),1==s.length)r=s[0];else if(null!==c)for(var p=0;p<s.length;p++)if(-1==e.inArray(s[p],c)){r=n.children('option[value="'+s[p]+'"]').val();break}null===c&&s.length>0&&(r=s);break;case"radiobuttons":case"checkboxes":s=o.getFieldValue(n),e(this).is(":checked")&&(r=e(this).val()),t=e(this).val();break;default:r=n.val()}o.debug("   Sel val: "+r);var u;switch(l.fields[i].type){case"checkboxes":""===r&&(u=t);break;case"selectmultiple":d.length>0&&(u=d);break;default:u=c}var h=n.data("doNotStore")||!1;a.recallValues&&null!==c&&c.length>0&&h===!1&&o.storeValues(n,c),n.data("old_val",s.length?s:r);var f=n.data("fieldOptions")||{};e.isArray(r)?e.each(r,function(e,t){o.processResponsePopulateDependents(n,l,a,f,i,t,u)}):o.processResponsePopulateDependents(n,l,a,f,i,r,u),n.prop("disabled",!1),n.data("doNotStore",!1)}),void(n.hasClass("jrAutoComplete")&&!n.hasClass("jrRelatedListing")&&e.inArray(n.data("fieldType"),["select","selectmultiple"])>-1&&(o.debug(" -> Activate AutoComplete UI for "+i),n.autocompletefield({lookup:"options",optionType:n.data("autocompleteType"),optionDivPosition:n.data("autocompletePos")})))):!0})}},this.processResponsePopulateDependents=function(t,a,i,n,l,s,d){if(cachedResp=null===s||n=={}?null:n[s],o.debug("   Cached response"),o.debug(void 0===cachedResp?"       Not cached":cachedResp),void 0===cachedResp&&""!==s&&null!==s){o.debug(" -> Change Event AJAX"),t.prop("disabled",!0);var c={"data[fields]":l,"data[value]":s,"data[page_setup]":!1,"data[context]":i.context,"data[fieldLocation]":i.fieldLocation,"data[referrer]":i.referrer,"data[autocomplete]":i.autocomplete},p=jreviews.dispatch({method:"GET",type:"json",controller:"fields",action:"_loadFieldData",data:c});p.done(function(e){o.debug("1 >-- Caching data for "+l+"["+s+"]");var i=t.data("fieldOptions")||{};i[s]=e,t.data("fieldOptions",i),t.data("eventType","ajax"),void 0===e.fields&&(e.fields=[]),o.populateOptions(e,a.fields[l],t,d,s),r.trigger("jrAfterFieldChange")})}else e.isEmptyObject(cachedResp)||""===s?(o.debug(" -> Change Event CLEAR"),t.data("eventType","clear"),o.clearDependents(t,d,s),r.trigger("jrAfterFieldChange")):(o.debug(" -> Change Event CACHED"),t.data("eventType","cached"),o.populateOptions(cachedResp,a.fields[l],t,d,s),r.trigger("jrAfterFieldChange"))},this.populateOptions=function(t,n,l,r,s){if(0!==t.length){n=void 0!==n?n:{type:"",name:""},o.debug("4 >--- Populate options for "+n.name+"["+s+"] and we clear it for ["+r+"]"),t.page_setup&&e.each(i,function(a,i){if(-1==e.inArray(i,t.dependent_groups)){var n=d.filter("fieldset#group_"+i),l=0;n.find(":input").each(function(){"hidden"!=e(this).prop("type")&&l++}),l>0&&(n.show(),c.length&&c.filter("li#tab_"+i).show(10))}}),e.each(t.dependent_groups,function(e,a){var i=d.filter("fieldset#group_"+a);i.data("isControlled",!0),t.page_setup?(i.css("display","none").data("isActive",!1),c.length&&c.filter("li#tab_"+a).hide()):(i.show().data("isActive",!0),c.length&&c.filter("li#tab_"+a).show(10))});var p=[];u&&(p=o.getPaidFields(),o.debug("   --- It is a paid listing!"),o.debug(p)),e.each(t.fields,function(i,n){if(o.debug("   --- Populating field "+n.name+"["+n.title+"]["+s+"]"),e.isArray(n.name))return!0;var l,r=o.getjQueryObj(t,n.name);if(l=r.prop("type"),"relatedlisting"!=n.type)switch(l){case"select-one":n.type="select";break;case"select-multiple":n.type="selectmultiple"}r.data("fieldTitle",n.title),0===t.page_setup&&e.inArray(n.type,["select","selectmultiple"])>-1&&r.val(""),t.page_setup&&(r.data("fieldName",n.name),r.data("fieldType",n.type),r.data("orderBy",n.order_by),r.data("hasControl",n.control),r.data("isControlled",n.controlled),r.data("autocompleteType",n.autocompletetype),r.data("autocompletePos",n.autocompletepos));var c=e.inArray(n.group,t.dependent_groups)>-1,h=d.filter("fieldset#group_"+n.group).data("isActive");if(1==t.control_field.length){var f=r.data("controlledBy")||{};if(f[t.control_field[0]]=t.control_value,c||r.data("controlledBy",f),(0===t.page_setup||void 0===t.page_setup)&&"text"==n.type&&n.controlled===!0&&n.controlgroup===!0)return!0}if(void 0===r.data("isActive")&&t.page_setup&&(e.inArray(n.type,["select","selectmultiple","relatedlisting"])>-1&&(n.control===!0&&n.controlled===!0||n.control===!1&&n.controlled===!0||"0"==n.autocomplete&&void 0===n.options)||e.inArray(n.type,["checkboxes","radiobuttons"])>-1&&(n.control===!0&&n.controlled===!0||n.control===!1&&n.controlled===!0)||!n.control&&n.controlled&&(void 0===n.selected||0===n.selected.length))){if("select"==n.type&&r.html(e("<option></option>").attr("value","").text(a.lang.select_field.replace("%s",r.data("fieldTitle"))).data("ordering",0)).children("option:eq(0)").prop("selected",!0),"function"==typeof r.relatedlisting&&!r.data("isControlled"))return r.data("isActive",!0),!0;o.debug("   ----- Hiding field "+n.name+" on startup");var v=r.data("click2add")||0;return(0===v||1==v&&r.data("isControlled"))&&r.data("isActive",!1).closest("div.jrFieldDiv").css("display","none"),!0}if("select"==n.type&&0===r.children("option").length&&r.html(e("<option></option>").attr("value","").text(a.lang.select_field.replace("%s",r.data("fieldTitle"))).data("ordering",0)),e.inArray(n.type,["select","selectmultiple","relatedlisting"])>-1&&(r.children('option[data-controlledBy="'+t.control_field[0]+'"]').each(function(){var a=e(this);a.data("controlValue")!=t.control_value&&a.remove()}),e(n.options).each(function(){0===r.children('option[value="'+this.value+'"]').length&&r.append(e("<option></option>").attr("value",this.value).text(this.text).attr("data-ordering",this.ordering))})),void 0!==n.selected&&n.selected.length>0&&(-1==e.inArray(n.type,["checkboxes","radiobuttons"])&&r.val(n.selected),r.data("old_val",n.selected),e(n.selected).each(function(e,a){n.name in t.responses&&a in t.responses[n.name]&&(o.debug("  +++++++ Start populateOptions recursion for "+n.name),r.data("eventType","cached"),o.populateOptions(t.responses[n.name][a],n,r,void 0,a))})),"select"==n.type&&0===r.find(":selected").length&&r.children("option:eq(0)").prop("selected",!0),!t.page_setup&&u&&-1==e.inArray(n.name,p))return r.data("isActive",!0),!0;if(o.debug("   ***** Start checks for displaying fields for ["+n.title+"]["+n.type+"]"),c&&h!==!0)r.data("isActive",!1).closest("div.jrFieldDiv").hide();else switch(n.type){case"select":r.children("option").length>1||1==r.data("click2add")&&!c||r.data("hasControl")===!0&&r.data("isControlled")===!1||r.data("hasControl")===!1&&r.data("isControlled")===!1?r.data("isActive",!0).closest("div.jrFieldDiv").show():r.data("isActive",!1).closest("div.jrFieldDiv").hide();break;case"selectmultiple":(r.children("option").length>0||1==r.data("click2add")&&!c||r.data("hasControl")===!0&&r.data("isControlled")===!1||r.data("hasControl")===!1&&r.data("isControlled")===!1)&&r.data("isActive",!0).closest("div.jrFieldDiv").show();break;case"checkboxes":case"radiobuttons":(!c||c&&h&&r.data("hasControl")===!0&&r.data("isControlled")===!1||r.data("hasControl")===!1&&r.data("isControlled")===!1)&&r.data("isActive",!0).closest("div.jrFieldDiv").show();break;default:r.data("isActive",!0).closest("div.jrFieldDiv").show()}r.children("option").length>0&&"ordering"==r.data("orderBy")&&o.sort_by_field(r)}),void 0!==l&&void 0!==r&&o.clearDependents(l,r,s),!t.page_setup&&a.recallValues&&(e(t.dependent_fields).each(function(t,a){o.recallValue(e("."+a),n.name,s)}),e.each(t.dependent_groups,function(t,a){d.filter("fieldset#group_"+a).find(":input").each(function(){var t=e(this).data("hasControl"),a=e(this).data("isControlled");(t||t===!1&&a===!1)&&o.recallValue(e(this),n.name,s)})}))}},this.sort_by_field=function(t){var a,i,n=t.val(),l=t.data("orderBy"),o="ordering"==l?function(e){return parseInt(e,10)}:function(e){return e.toUpperCase()};a=t.prop("type"),"select-one"==a&&(i=t.children('option[value=""]').detach());var r=t.children("option").sort(function(t,a){return t="ordering"==l?e(t).data("ordering"):t.text,a="ordering"==l?e(a).data("ordering"):a.text,"undefined"!=typeof o&&(t=o(t),a=o(a)),a>t?-1:t>a?1:0});void 0!==i?t.html(r).prepend(i).val(n):t.html(r).val(n)},this.debug=function(e){l&&console.log(e)}}e.fn.jreviewsFields=function(e){var a=new t(this);return a.loadData(e)},e.fn.jrSetValidFields=function(){var e=new t(this);return e.setValidFields(this)},e.fn.jrApplyFieldOptionLayout=function(){this.find(".jrFieldDiv:visible:has(.jr-option)").each(function(){var t=e(this),a=t.parents('[role="tabpanel"]');if(a.length){var i=a.css("display");a.css("display","block")}var n=t.find(".jr-option"),l=Math.max.apply(Math,n.map(function(){return e(this).width()}).get());l>0&&n.removeClass("jrOptionMinWidth").css("min-width",l+"px"),a.length&&a.css("display",i)})}}(jQuery),function(e){e.widget("jreviews.autocompletefield",{lookup:"options",options:{entry_id:null,optionType:"link",optionDivPosition:"after",minSearchLength:1,lang:{help:jreviews.__t("FIELD_AUTOCOMPLETE_HELP"),no_results:jreviews.__t("FIELD_NO_RESULTS")},helpClass:"acInstructions",inputClass:"jrAutoSuggest",disabledLinkClass:"ui-disabled",checkboxClass:"ui-option",optionsDivClass:"ui-optionsDiv"},_create:function(t){e.extend(this.options,t);var a=this,i=a.element.hide(),n=a.options,l=a.fname=i.data("fieldName"),o=a.widgetid="text-"+l;a.lookup=n.lookup,i.data("validation",!1);var r=(this.searchInput=e('<input type="text" />')).attr({id:o,name:o}).addClass(n.helpClass+" "+n.inputClass).insertAfter(i);void 0!=i.attr("placeholder")?r.attr("placeholder",i.attr("placeholder")):r.val(n.lang.help);{var s=(this.optionsDiv=e("<div></div")).attr("data-fname",l).addClass(n.optionsDivClass+" jrClearfix");(this.noResults=e("<span></span>")).html(n.lang.no_results).css("margin-left","5px").addClass("jrValidation")}switch(n.optionDivPosition){case"before":s.insertBefore(r);break;case"after":s.insertAfter(r)}this._bindEvents()},_init:function(){var t=this,a=t.element,i=t.options,n=t.optionsDiv,l=a.children("option:selected");switch(l.length&&e.each(l,function(){var a=e(this);if(""===a.val())return!0;switch(i.optionType){case"link":var l=t._createLink({value:a.val(),text:a.text(),checked:!0});break;case"checkbox":l=t._createCheckbox({value:a.val(),text:a.text(),checked:!0})}n.append(l)}),i.optionType){case"link":0===n.find("a").length?n.hide():n.show(5);break;case"checkbox":0===n.find("input").length?n.hide():n.show(5)}},_createCheckbox:function(t){var a=this.fname,i=this.options,n="cb-"+a+"_"+t.value.replace(/ /g,"_"),l=e('<input type="checkbox" />').attr({id:n,name:n}).addClass(i.checkboxClass).val(t.value).prop("checked",t.checked),o=e('<label for="'+n+'" />').css("text-align","left").append(l).append("<span>"+t.text+"</span>");return o},_createLink:function(t){var a=this.options;return e('<a href="javascript:void(0)"></a>').addClass(a.checkboxClass).html(t.text).attr("data-value",t.value).data("active",t.checked?!0:!1)},_getListingData:function(e,t,a){var i=this.element;a=a||"";var n={limit:12,id:a,fname:i.attr("class").split(" ")[0],listingtype:i.data("listingtype")||"",value:e},l=jreviews.dispatch({method:"get",type:"json",controller:"fields",action:"relatedListings",data:n});l.done(function(e){t(e)})},_bindEvents:function(){var t=this,a=t.element,i=t.options,n=t.searchInput,l=t.optionsDiv;switch(void 0==n.attr("placeholder")&&n.on("click focusin",function(){this.value==i.lang.help&&e(this).val("").removeClass(i.helpClass)}).on("blur focusout",function(){""===this.value&&e(this).val(i.lang.help).addClass(i.helpClass)}),this._bindAutoComplete(),l.delegate(":input:checkbox","change",function(){var t=e(this),i=t.val(),n=t.next("span").html(),l=a.children('option[value="'+i+'"]');return t.is(":checked")?l.length>0?l.prop("selected",!0):l.append(e("<option></option>").attr("value",i).text(n)):l.length>0&&l.prop("selected",!1),a.trigger("change"),!1}).delegate("a","click",function(){var t=e(this),n=t.data("value"),l=t.html(),o=a.children('option[value="'+n+'"]');return t.data("active")===!1?(t.data("active",!0).removeClass(i.disabledLinkClass),o.length>0?o.prop("selected",!0):o.append(e("<option></option>").attr("value",n).text(l))):o.length>0&&(t.data("active",!1).addClass(i.disabledLinkClass),o.prop("selected",!1)),a.trigger("change"),!1}),i.optionType){case"link":this._bindForLinks();break;case"checkbox":this._bindForCheckboxes()}this._bindClick2Add()},_bindForCheckboxes:function(){var t=this,a=t.element,i=(t.options,t.optionsDiv);a.on("change",function(){var n=i.find(":input"),l=a.children("option"),o=l.map(function(){return this.value});l.each(function(){var a=e(this),n=a.val();if(""!==n){var l=i.find(':input[value="'+n+'"]');a.is(":selected")===!1?l.length&&l.prop("checked",!1):l.length?l.prop("checked",!0):i.show(5).append(t._createCheckbox({value:n,text:a.text(),checked:!0}))}}),n.each(function(){var t=e(this);-1==e.inArray(t.val(),o)&&t.closest("label").remove()}),0===i.find(":input").length&&i.hide()})},_bindForLinks:function(){var t=this,a=t.element,i=t.options,n=t.optionsDiv;a.on("change",function(){var l=n.find("a"),o=a.children("option"),r=o.map(function(){return this.value});o.each(function(){var a=e(this),l=a.val();if(""!==l){var o=n.find('a[data-value="'+l+'"]');a.is(":selected")===!1?o.length&&o.data("active",!1).addClass(i.disabledLinkClass):o.length?o.data("active",!0).removeClass(i.disabledLinkClass):n.show(5).append(t._createLink({value:l,text:a.text(),checked:!0}))}}),l.each(function(){var t=e(this);-1==e.inArray(String(t.data("value")),r)&&t.remove()}),0===n.find("a").length&&n.hide()})},_bindAutoComplete:function(){var t=this,a=t.element,i=t.options,n=t.searchInput,l=t.optionsDiv,o=void 0!==a.data("field")?a.data("field").id:"",r=(t.fname,jreviews.isRTL?"right top":"left top"),s=jreviews.isRTL?"right bottom":"left bottom";n.autocomplete({position:{my:r,at:s},minLength:i.minSearchLength,source:function(n,r){var s,d=n.term.toLowerCase(),c=[];switch(i.optionType){case"link":s=l.find("a").map(function(){return e(this).data("value")});break;case"checkbox":s=l.find(":input").map(function(){return this.value})}if(a.data("isControlled")&&"listings"!=t.lookup){var p=new RegExp(e.ui.autocomplete.escapeRegex(n.term),"i");c=a.children("option").map(function(){var t=e(this).text();return""===this.value||n.term&&!p.test(t)||-1!=e.inArray(this.value,s)?void 0:{label:t,value:this.value}}),r(c),t._noMatch(c)}else switch(t.lookup){case"listings":t._getListingData(d,function(i){e(i).each(function(t,i){void 0===i||-1!=e.inArray(parseInt(i.value,10),s)&&!e.inArray(i.value,a.val())||c.push(i)}),r(c),t._noMatch(c)},i.entry_id);break;case"options":var u={limit:12,field_id:o,value:d},h=jreviews.dispatch({method:"get",type:"json",controller:"fields",action:"_loadValues",data:u});h.done(function(i){e(i).each(function(t,i){void 0===i||-1!=e.inArray(i.value,s)&&!e.inArray(i.value,a.val())||c.push(i)}),r(c),t._noMatch(c)})}},search:function(){return"options"==this.lookup&&""===o?!1:void 0},focus:function(e,t){return n.val(t.item.label),!1},select:function(t,i){if(""!==i.item.value){n.val("").focus();var l,o=a.val()||[],r=a.children('option[value="'+i.item.value+'"]');a.val(""),0===r.length&&a.append(e("<option></option>").attr({value:i.item.value}).text(i.item.label)),l=a.prop("type"),"select-multiple"==l?(o.push(i.item.value),a.val(o)):a.val(i.item.value),a.trigger("change"),a.trigger("autoCompleteSelect")}return n.val(""),!1}}),e(".ui-autocomplete").addClass("jrAutoComplete")},_bindClick2Add:function(){var t=this.element,a=this.options,i=this.searchInput;1==t.data("click2add")&&e('<button class="jrButton" />').html('<span class="jrIconNew"></span>'+jreviews.__t("FIELD_ADD_OPTION")).on("click",function(n){n.preventDefault();var l,o,r=i.val(),s="";!t.data("controlledBy")||t.data("fieldName")in t.data("controlledBy")||e.each(t.data("controlledBy"),function(e,t){l=e,o=t,s="|"+e+"|"+t});var d=encodeURIComponent(r).replace(/'/g,"&#039;")+"|click2add"+s,c=t.children('option[value="'+d+'"]');""!==r&&r!=a.lang.help&&0===c.length?(t.append(e("<option></option>").attr({value:d,selected:"selected","data-ordering":99999,"data-controlledBy":l,"data-controlValue":o}).text(r)).trigger("change"),i.val("")):1==c.length&&(c.prop("selected",!0),t.trigger("change")),i.focus()}).insertAfter(i)},_noMatch:function(t){var a=this.element,i=this.noResults;0===t.length&&a.data("validation")===!1&&(a.prevAll("label:eq(0)").append(i).data("validation",!0),i.fadeIn(100).delay(3e3).fadeOut(500,function(){e(this).detach(),a.data("validation",!1)}))},_destroy:function(){}})}(jQuery),function(e){jreviewsFormBuilder=function(t,a){this.formbuilder=t,this.settings=e.extend({showModel:!1},a)},jreviewsFormBuilder.prototype={constructor:jreviewsFormBuilder,options:{theme:"jreviews",iconlib:"jreviews",schema:{},ajax:!0,startval:null,disable_collapse:!0,disable_array_delete_all_rows:!0,disable_array_delete_last_row:!0,disable_properties:!0,disable_edit_json:!0,no_additional_properties:!0},form:null,formbuilder:null,schema:null,model:null,editor:null,initialize:function(){function t(t){t.find(".jrFormHeading").each(function(){e(this).parent().hasClass("jrFormBuilderPanel")||a(t)})}function a(t){t.find(".jrButtonGroup").each(function(){e(this).children(".jrButton:visible:last").addClass("jrButtonLast"),e(this).children(".jrButton:visible:first").addClass("jrButtonFirst");var t=e(this).children("button").length;e(this).children("button:hidden").length==t&&0==e(this).find(".json-editor-btn-add").length&&0==e(this).find(".json-editor-btn-delete").length&&e(this).hide()})}var i=this;if(i.formbuilder.data("initialized")===!0)return console.log("FormBuilder already initialized"),i;i.schema=i.formbuilder.find("[jr-schema]").css("display","none"),i.model=i.formbuilder.find("[jr-model]").css("display","none");try{if(i.options.schema=JSON.parse(i.schema.val()||"{}"),JSON.stringify(i.options.schema)==JSON.stringify({}))return i}catch(n){return i}i.formbuilder.data("initialized",!0);try{var l=i.model.val();"{}"!==l&&"[]"!=l&&""!=l?i.options.startval=JSON.parse(l):delete i.options.startval}catch(n){delete i.options.startval}var o=i.formbuilder.find("[jr-form]");return this.settings.showModel&&i.model.css("display","block"),JSONEditor.defaults.editors.select.prototype.setupSelect2=function(){this.select2=null},JSONEditor.prototype._loadExternalRefs=function(t,a){var i,n=this,l=this._getExternalRefs(t),o=0,r=0,s=!1;e.each(l,function(e){if(!n.refs[e]){if(!n.options.ajax)throw"Must set ajax option to true to load external ref "+e;switch(n.refs[e]="loading",r++,jreviews.cms){case 1:i=e.replace("DEFINITIONS_PATH",jreviews.relpath+"/components/com_jreviews/jreviews/views/themes/default/fields_formbuilder/definitions");break;case 2:i=e.replace("DEFINITIONS_PATH",jreviews.relpath+"/wp-content/plugins/jreviews/jreviews/views/themes/default/fields_formbuilder/definitions")}var t=new XMLHttpRequest;t.open("GET",i,!0),t.onreadystatechange=function(){if(4==t.readyState){if(200!==t.status)throw window.console.log(t),"Failed to fetch ref via ajax- "+e;var i;try{i=JSON.parse(t.responseText)}catch(l){throw window.console.log(l),"Failed to parse external ref "+e}if(!i||"object"!=typeof i)throw"External ref does not contain a valid schema - "+e;n.refs[e]=i,n._loadExternalRefs(i,function(){o++,o>=r&&!s&&(s=!0,a())})}},t.send()}}),r||a()},i.form=new JSONEditor(o[0],i.options),i.initializing=!0,i.form.on("ready",function(){t(o)}),i.form.on("change",function(){i.initializing!==!0&&(i.model.val(JSON.stringify(i.form.getValue(),null,2)),a(o));var e=i.form.validate();e.length?console.log("FormBuilder Validation",JSON.stringify(e,null,2)):console.log("FormBuilder Validation: valid"),i.initializing=!1}),i},updateSchema:function(e){this.editor?this.editor.setValue(JSON.stringify(e,null,2),-1):this.schema.val(JSON.stringify(e,null,2)),this.reload()},reload:function(){this.destroy().initialize(this.formbuilder)},destroy:function(){return this.formbuilder.data("initialized",!1),this.form&&this.form.destroy(),this.formbuilder.find("[jr-form]").html(""),this.model.val("[]"),this},addEditor:function(){var e=this,t=e.formbuilder.find("[jr-schema-editor]");return t.length&&null==this.editor&&(e.editor=ace.edit(t[0]),e.editor.getSession().setMode("ace/mode/"+t.data("format")),e.editor.setValue(e.schema.val(),-1),e.editor.on("change",function(){e.schema.val(e.editor.getValue())})),e}}}(jQuery);